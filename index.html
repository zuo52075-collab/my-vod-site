<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>奶香香影視 - 如意穩定版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #ec4899; --dark: #0f172a; }
        body { background-color: var(--dark); color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        .video-card { transition: all 0.3s ease; cursor: pointer; }
        .video-card:hover { transform: translateY(-8px); }
        .loading-spinner {
            border: 3px solid rgba(236, 72, 153, 0.1); border-top: 3px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .player-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: 12px; overflow: hidden; }
        .player-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .view-hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .cat-active { background: #ec4899 !important; color: white !important; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 驗證層 -->
    <div id="authOverlay" class="fixed inset-0 z-[9999] bg-slate-900 flex items-center justify-center">
        <div class="w-full max-w-md p-8 bg-slate-800/50 rounded-3xl border border-slate-700 backdrop-blur-xl shadow-2xl mx-4 text-center">
            <div class="bg-pink-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-6 shadow-lg shadow-pink-500/20">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1 class="text-2xl font-black text-white mb-2">如意資源庫</h1>
            <p class="text-slate-400 text-sm mb-8">請輸入密碼解鎖內容</p>
            <input type="password" id="passwordInput" placeholder="請輸入密碼" 
                class="w-full bg-slate-900 border border-slate-700 rounded-xl py-4 px-6 text-white text-center tracking-widest focus:ring-2 focus:ring-pink-500 outline-none mb-6">
            <button onclick="checkAuth()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95">
                驗證並進入
            </button>
            <p id="authError" class="text-red-400 text-xs mt-4 opacity-0 transition-opacity">密碼錯誤，請重新輸入</p>
        </div>
    </div>

    <!-- 主內容 -->
    <div id="mainContent" class="opacity-0 transition-opacity duration-700 flex flex-col flex-1">
        <nav class="sticky top-0 z-50 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 px-4 py-3">
            <div class="max-w-7xl mx-auto flex flex-col gap-3">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                        <div class="bg-pink-600 p-2 rounded-lg text-white"><i class="fas fa-play"></i></div>
                        <span class="text-xl font-bold">奶香香影視</span>
                    </div>
                    <div class="relative flex-1 max-w-md">
                        <input type="text" id="searchInput" placeholder="搜尋如意資源..." 
                            class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 px-10 text-sm text-white focus:ring-2 focus:ring-pink-500 outline-none">
                        <i class="fas fa-search absolute left-4 top-2.5 text-slate-500"></i>
                    </div>
                    <button onclick="goHome()" class="text-slate-400 hover:text-white"><i class="fas fa-home text-lg"></i></button>
                </div>
                <div id="categoryNav" class="flex items-center gap-2 overflow-x-auto pb-1 custom-scrollbar">
                    <button onclick="changeCat('', this)" class="cat-btn cat-active flex-shrink-0 px-4 py-1 rounded-full bg-slate-800 text-xs text-slate-300">全部</button>
                    <button onclick="changeCat('1', this)" class="cat-btn flex-shrink-0 px-4 py-1 rounded-full bg-slate-800 text-xs text-slate-300">電影</button>
                    <button onclick="changeCat('2', this)" class="cat-btn flex-shrink-0 px-4 py-1 rounded-full bg-slate-800 text-xs text-slate-300">連續劇</button>
                    <button onclick="changeCat('3', this)" class="cat-btn flex-shrink-0 px-4 py-1 rounded-full bg-slate-800 text-xs text-slate-300">綜藝</button>
                    <button onclick="changeCat('4', this)" class="cat-btn flex-shrink-0 px-4 py-1 rounded-full bg-slate-800 text-xs text-slate-300">動漫</button>
                </div>
            </div>
        </nav>

        <main id="homeView" class="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
            <div id="videoGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            <div id="pagination" class="mt-12 flex justify-center items-center gap-6 py-8 border-t border-slate-800">
                <button id="prevBtn" class="bg-slate-800 hover:bg-pink-600 px-6 py-2 rounded-full disabled:opacity-30 text-xs font-bold transition-all">上一頁</button>
                <span id="pageInfo" class="text-slate-400 font-mono text-xs">1 / 1</span>
                <button id="nextBtn" class="bg-slate-800 hover:bg-pink-600 px-6 py-2 rounded-full text-xs font-bold transition-all">下一頁</button>
            </div>
        </main>

        <main id="playerView" class="flex-1 w-full view-hidden bg-slate-950">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <button onclick="goHome()" class="mb-6 text-slate-400 hover:text-pink-500 flex items-center gap-2 text-sm font-bold">
                    <i class="fas fa-arrow-left"></i> 返回首頁
                </button>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-3 space-y-6">
                        <div class="player-wrapper shadow-2xl">
                            <iframe id="mainIframe" allowfullscreen sandbox="allow-forms allow-scripts allow-same-origin allow-presentation"></iframe>
                        </div>
                        <div class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
                            <h2 id="detailTitle" class="text-2xl font-bold text-white mb-2">標題加載中...</h2>
                            <div class="flex gap-2">
                                <span id="detailType" class="px-2 py-1 bg-slate-800 text-slate-400 text-[10px] rounded">分類</span>
                                <span id="detailRemark" class="px-2 py-1 bg-pink-600 text-white text-[10px] rounded">狀態</span>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6">
                            <h3 class="text-sm font-bold text-white mb-4 border-l-4 border-pink-500 pl-3">播放列表 (如意源)</h3>
                            <div id="sourceSwitcher" class="flex gap-2 mb-4 overflow-x-auto pb-2 custom-scrollbar"></div>
                            <div id="detailEpisodeList" class="grid grid-cols-2 gap-2 max-h-[50vh] overflow-y-auto pr-1 custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const AUTH_KEY = '120120520zz';
        const CONFIG = {
            // 主域名與備用域名列表
            apiDomains: [
                'https://cj.rycjapi.com/api.php/provide/vod/',
                'https://cj.rytvapi.com/api.php/provide/vod/'
            ],
            // 優化後的代理節點，手機端建議優先使用 fast-reverse 代理
            proxies: [
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                (url) => url // 最後嘗試直連（部分移動網路直連反而快）
            ],
            playerBase: 'https://jx.m3u8.tv/jiexi/?url='
        };

        let state = {
            page: 1, search: '', type: '', 
            currentVideoData: null, allLoadedData: []
        };

        function checkAuth() {
            const input = document.getElementById('passwordInput').value;
            if (input === AUTH_KEY) {
                sessionStorage.setItem('isNaxxAuthed', 'true');
                unlockSite();
            } else {
                const err = document.getElementById('authError');
                err.style.opacity = '1';
                setTimeout(() => err.style.opacity = '0', 2000);
            }
        }

        function unlockSite() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.remove('opacity-0');
            fetchList();
        }

        async function fetchList() {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = `<div class="col-span-full flex flex-col items-center py-32"><div class="loading-spinner mb-4"></div><p class="text-slate-500 text-xs font-bold animate-pulse">正在嘗試優選加速節點...</p></div>`;
            
            let success = false;

            // 遍歷所有域名
            for (const domain of CONFIG.apiDomains) {
                if (success) break;

                let targetUrl = `${domain}?ac=detail&pg=${state.page}`;
                if (state.search) targetUrl += `&wd=${encodeURIComponent(state.search)}`;
                if (state.type) targetUrl += `&t=${state.type}`;

                // 遍歷所有代理
                for (const proxyFn of CONFIG.proxies) {
                    try {
                        const finalUrl = proxyFn(targetUrl);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 縮短超時時間至5秒，快速切換
                        
                        const response = await fetch(finalUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) continue;

                        let data = await response.json();
                        if (data.contents) data = JSON.parse(data.contents);

                        const result = Array.isArray(data) ? data[0] : data;
                        if (result && result.list) {
                            state.allLoadedData = result.list;
                            renderList(result.list);
                            document.getElementById('pageInfo').innerText = `${result.page} / ${result.pagecount}`;
                            document.getElementById('prevBtn').disabled = result.page <= 1;
                            document.getElementById('nextBtn').disabled = result.page >= result.pagecount;
                            success = true;
                            break; 
                        }
                    } catch (err) {
                        console.warn('加速節點繁忙，切換中...');
                    }
                }
            }

            if (!success) {
                grid.innerHTML = `<div class="col-span-full py-32 text-center text-red-400"><i class="fas fa-wifi text-3xl mb-4"></i><p>加速節點全部超時，請檢查手機網絡或刷新重試。</p><button onclick="fetchList()" class="mt-4 bg-slate-800 px-6 py-2 rounded-full text-white text-xs">重新連線</button></div>`;
            }
        }

        function renderList(list) {
            document.getElementById('videoGrid').innerHTML = list.map(item => `
                <div class="video-card group" onclick="showPlayer(${item.vod_id})">
                    <div class="relative aspect-[3/4.5] rounded-xl overflow-hidden bg-slate-800 shadow-lg">
                        <img src="${item.vod_pic}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/300x450?text=RY+Media'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent opacity-40"></div>
                        <div class="absolute bottom-2 right-2 bg-pink-600 text-[9px] font-bold text-white px-2 py-0.5 rounded shadow">
                            ${item.vod_remarks || '高清'}
                        </div>
                    </div>
                    <div class="mt-3 px-1">
                        <h3 class="text-xs font-bold text-slate-200 group-hover:text-pink-500 truncate transition-colors">${item.vod_name}</h3>
                        <p class="text-[10px] text-slate-500 mt-0.5">${item.type_name}</p>
                    </div>
                </div>
            `).join('');
        }

        window.showPlayer = function(id) {
            const video = state.allLoadedData.find(v => v.vod_id == id);
            if (!video) return;
            state.currentVideoData = video;
            document.getElementById('homeView').classList.add('view-hidden');
            document.getElementById('playerView').classList.remove('view-hidden');
            window.scrollTo(0,0);
            document.getElementById('detailTitle').innerText = video.vod_name;
            document.getElementById('detailRemark').innerText = video.vod_remarks;
            document.getElementById('detailType').innerText = video.type_name;
            renderEpisodes(0);
        };

        function renderEpisodes(sourceIdx) {
            const v = state.currentVideoData;
            const names = v.vod_play_from.split('$$$');
            const urlGroups = v.vod_play_url.split('$$$');
            
            document.getElementById('sourceSwitcher').innerHTML = names.map((n, i) => `
                <button onclick="renderEpisodes(${i})" class="flex-shrink-0 text-[10px] px-3 py-1 rounded border ${sourceIdx === i ? 'bg-pink-600 border-pink-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'} transition-colors">
                    ${n.toUpperCase()}
                </button>
            `).join('');

            const episodes = (urlGroups[sourceIdx] || "").split('#').filter(s => s.trim()).map(s => {
                const p = s.split('$');
                return { name: p[0], link: p[1] || p[0] };
            });

            const list = document.getElementById('detailEpisodeList');
            list.innerHTML = episodes.map((ep, i) => `
                <button onclick="playVideo('${ep.link}', this)" class="ep-btn p-2 text-[10px] rounded bg-slate-800/60 border border-slate-700 text-slate-300 hover:border-pink-500 truncate transition-all">
                    ${ep.name}
                </button>
            `).join('');

            if (episodes.length > 0) playVideo(episodes[0].link, list.firstElementChild);
        }

        window.playVideo = function(url, btn) {
            document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('bg-pink-600', 'text-white', 'border-pink-500'));
            if (btn) btn.classList.add('bg-pink-600', 'text-white', 'border-pink-500');
            
            let finalUrl = url.trim();
            if (finalUrl.startsWith('//')) finalUrl = 'https:' + finalUrl;
            document.getElementById('mainIframe').src = CONFIG.playerBase + encodeURIComponent(finalUrl);
        };

        window.goHome = function() {
            document.getElementById('homeView').classList.remove('view-hidden');
            document.getElementById('playerView').classList.add('view-hidden');
            document.getElementById('mainIframe').src = '';
        };

        window.changeCat = function(tid, btn) {
            state.type = tid; state.page = 1; state.search = '';
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('cat-active'));
            btn.classList.add('cat-active');
            fetchList();
        };

        document.getElementById('searchInput').onkeypress = (e) => {
            if (e.key === 'Enter') { state.search = e.target.value; state.page = 1; fetchList(); }
        };

        document.getElementById('prevBtn').onclick = () => { if (state.page > 1) { state.page--; fetchList(); window.scrollTo(0,0); } };
        document.getElementById('nextBtn').onclick = () => { state.page++; fetchList(); window.scrollTo(0,0); };
        document.getElementById('passwordInput').onkeypress = (e) => { if (e.key === 'Enter') checkAuth(); };

        window.onload = () => {
            if (sessionStorage.getItem('isNaxxAuthed') === 'true') unlockSite();
        };
    </script>
</body>
</html>
